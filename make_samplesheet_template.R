#!/usr/bin/env Rscript
my_r_env <- "/mnt/beegfs/kimj32/tools/R_env/"
.libPaths(my_r_env)
library(optparse)
suppressMessages(library(dplyr))
library(readr)
library(stringr)

option_list <- list(
  make_option(c("-s", "--sample_rgx"), type="character", default="^([^-]+)",
              help="regex for sample [default= %default]", metavar="character"),
  make_option(c("-r", "--group_rgx"), type="character", default="^([^-]+)",
              help="regex for group [default= %default]", metavar="character"),
  make_option(c("-g", "--geno_rgx"), type="character", default="^([^-]+)",
              help="regex for genotype [default= %default]", metavar="character"),
  make_option(c("-c", "--cond_rgx"), type="character", default="^([^-]+)",
              help="regex for condition [default= %default]", metavar="character"),
  make_option(c("-u", "--unit_rgx"), type="character", default="^([^-]+)",
              help="regex for unit [default= %default]", metavar="character"),
  make_option(c("-i", "--fq_dir"), type="character")
);

opt_parser <- OptionParser(option_list=option_list);
opt <- parse_args(opt_parser);


fq_files <- file.path(opt$fq_dir, list.files(opt$fq_dir, pattern = "*fastq.gz|*fq.gz", recursive=FALSE)) %>%
    normalizePath() %>%
    unlist()

R1_files <- grep("-R1[_\\.]", fq_files, value = TRUE)

# sample    group    genotype    condition    unit    fq1    fq2    strandedness
df <- data.frame(fq1 = R1_files) %>%
mutate(sample = str_extract(basename(fq1), opt$sample_rgx),
       group = str_extract(basename(fq1), opt$group_rgx),
       genotype = str_extract(basename(fq1), opt$geno_rgx),
       condition = str_extract(basename(fq1), opt$cond_rgx),
       unit = str_extract(basename(fq1), opt$unit_rgx),
       fq2 = str_replace(fq1, "-R1([_\\.])", "-R2\\1"),
       strandedness = "reverse") %>%
arrange(sample) %>%
select(sample,fq1,fq2)

# make sure no fq file listed more than once.
stopifnot(length(df$fq1) == length(unique(df$fq1)))
stopifnot(length(df$fq2) == length(unique(df$fq2)))
stopifnot(length(c(df$fq1, df$fq2)) == length(unique(c(df$fq1, df$fq2))))

# make sure all R2 files have 'R2' in the name
stopifnot(sum(str_detect(df$fq2, "-R2[_\\.]")) == length(df$fq2))
stopifnot(sum(str_detect(df$fq1, "-R1[_\\.]")) == length(df$fq1))

# make all found fastq files listed
stopifnot(all(sort(c(df$fq1, df$fq2)) == sort(fq_files)))

write_csv(df, "samplesheet.csv")